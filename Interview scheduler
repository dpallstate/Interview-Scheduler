<script>
(() => {
  // ---------- Utilities ----------
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
  const pad2 = (n) => String(n).padStart(2, '0');
  const formatInTZ = (date, tz, opts) =>
    new Intl.DateTimeFormat('en-US', { timeZone: tz, ...opts }).format(date);
  const download = (filename, content) => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type: 'text/plain' }));
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  };
  const todayLocalMidnight = () => {
    const t = new Date();
    return new Date(t.getFullYear(), t.getMonth(), t.getDate(), 0, 0, 0, 0);
  };

  // Inject minimal CSS so selected slots are visibly green even without external styles
  (function injectSafetyStyles() {
    const css = `
      .slot-picked { background:#dcfce7!important; border-color:#22c55e!important; }
      .hidden { display: none !important; }
      ._sched_error { padding:1rem; border:1px solid #ef4444; color:#991b1b; background:#fee2e2; border-radius:.5rem; margin:1rem 0; }
    `;
    const style = document.createElement('style');
    style.setAttribute('data-scheduler-inline-style','1');
    style.textContent = css;
    document.head.appendChild(style);
  })();

  // ---------- State ----------
  const US_TZS = [
    'America/New_York','America/Chicago','America/Denver',
    'America/Los_Angeles','America/Phoenix','America/Anchorage','Pacific/Honolulu'
  ];
  let state = {
    session: '',
    role: 'candidate',
    viewMonth: null,
    selectedDate: null,
    tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
    duration: 30,
    picks: {} // { 'YYYY-MM-DD': ['HH:MM', ...] }
  };

  // Demo in-memory store (replace with real backend)
  window.__demoStore = window.__demoStore || {};

  // ---------- DOM Elements (centralized) ----------
  const elements = {
    sessionIdInput: null,
    roleSelect: null,
    tzSelect: null,
    durationSelect: null,
    monthLabel: null,
    calendarGrid: null,
    dateSelection: null,
    timeSelection: null,
    confirmation: null,
    successMessage: null,
    selectedDateSpan: null,
    timeSlotsContainer: null,
    pickedPreview: null,
    autobookResult: null,
    shareModal: null,
    candLinkText: null,
    cliLinkText: null,
    brandLogo: null,
  };

  const REQUIRED_IDS = [
    'session-id','role-select','tz-select','duration','month-label','calendar-grid',
    'date-selection','time-selection','confirmation','success-message','selected-date',
    'time-slots','picked-preview','autobook-result','share-modal',
    'cand-link','cli-link','brand-logo',
    // Buttons:
    'prev-month','next-month','new-session','submit-day-slots','back-to-time',
    'submit-availability','schedule-another','copy-links','close-share','copy-cand','copy-cli','download-share'
  ];

  function bindElementsOrReport() {
    const missing = [];
    REQUIRED_IDS.forEach(id => {
      const node = document.getElementById(id);
      if (!node) missing.push(id);
      else {
        // map only the ones we track in elements
        if (id in elements) elements[idToKey(id)] = node;
      }
    });
    if (missing.length) {
      const msg = document.createElement('div');
      msg.className = '_sched_error';
      msg.innerHTML = `<strong>Scheduler setup error:</strong> Missing required element IDs:<br><code>${missing.join(', ')}</code>`;
      document.body.prepend(msg);
      // We won't throw—allow page to continue. But we skip wiring listeners that rely on missing nodes.
    }
  }
  function idToKey(id) {
    return ({
      'session-id':'sessionIdInput',
      'role-select':'roleSelect',
      'tz-select':'tzSelect',
      'duration':'durationSelect',
      'month-label':'monthLabel',
      'calendar-grid':'calendarGrid',
      'date-selection':'dateSelection',
      'time-selection':'timeSelection',
      'confirmation':'confirmation',
      'success-message':'successMessage',
      'selected-date':'selectedDateSpan',
      'time-slots':'timeSlotsContainer',
      'picked-preview':'pickedPreview',
      'autobook-result':'autobookResult',
      'share-modal':'shareModal',
      'cand-link':'candLinkText',
      'cli-link':'cliLinkText',
      'brand-logo':'brandLogo',
    }[id]) || id;
  }

  // ---------- Session & URL ----------
  const newSessionId = () => Math.random().toString(36).slice(2, 8);
  const getParams = () => Object.fromEntries(new URL(location.href).searchParams.entries());
  function buildShareLinks() {
    if (!state.session) throw new Error('Missing session ID');
    const base = location.href.split('?')[0];
    return {
      cand: `${base}?session=${encodeURIComponent(state.session)}&role=candidate`,
      cli: `${base}?session=${encodeURIComponent(state.session)}&role=client`
    };
  }

  // ---------- Persistence ----------
  const lsKey = () => `sched:${state.session}:${state.role}`;
  function saveLocal() {
    if (!state.session) return;
    const data = {
      tz: state.tz, duration: state.duration,
      picks: state.picks, selectedDate: state.selectedDate?.toISOString() || null,
      viewMonth: state.viewMonth?.toISOString() || null
    };
    try { localStorage.setItem(lsKey(), JSON.stringify(data)); } catch {}
  }
  function loadLocal() {
    if (!state.session) return false;
    try {
      const raw = localStorage.getItem(lsKey());
      if (!raw) return false;
      const data = JSON.parse(raw);
      if (data.tz) state.tz = data.tz;
      if (data.duration) state.duration = data.duration;
      if (data.picks) state.picks = data.picks;
      if (data.selectedDate) state.selectedDate = new Date(data.selectedDate);
      if (data.viewMonth) state.viewMonth = new Date(data.viewMonth);
      return true;
    } catch { return false; }
  }

  // ---------- UI Updates ----------
  function updateStepIndicator(step) {
    for (let i = 1; i <= 3; i++) {
      const indicator = document.getElementById(`step${i}-indicator`);
      if (!indicator) continue;
      const circle = indicator.querySelector('div');
      const text = indicator.querySelector('span');
      const isActive = i <= step;
      if (circle) circle.className = `w-8 h-8 rounded-full flex items-center justify-center font-semibold ${isActive ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}`;
      if (text) text.className = `ml-2 font-medium ${isActive ? 'text-blue-600' : 'text-gray-500'}`;
    }
  }

  function renderCalendar() {
    if (!elements.monthLabel || !elements.calendarGrid) return;
    if (!state.viewMonth) {
      state.viewMonth = new Date();
      state.viewMonth.setDate(1);
    }
    elements.monthLabel.textContent = state.viewMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' });

    const firstDay = new Date(state.viewMonth.getFullYear(), state.viewMonth.getMonth(), 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    const today = todayLocalMidnight();

    let cellsHtml = '';
    for (let i = 0; i < 42; i++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      const ymd = `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}`;

      const inMonth = date.getMonth() === state.viewMonth.getMonth();
      const isPast = date < today;
      const isWeekend = [0, 6].includes(date.getDay());
      const isDisabled = !inMonth || isPast || isWeekend;

      const isSelected =
        state.selectedDate &&
        date.getFullYear() === state.selectedDate.getFullYear() &&
        date.getMonth() === state.selectedDate.getMonth() &&
        date.getDate() === state.selectedDate.getDate();

      const classes = [
        'calendar-day text-center py-3 rounded-lg border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500',
        isDisabled ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-blue-100 hover:border-blue-300',
        isSelected ? 'bg-blue-600 text-white border-blue-600 selected' : ''
      ].join(' ');

      cellsHtml += `<button type="button" class="${classes}" data-date="${ymd}" ${isDisabled ? 'disabled' : ''} aria-disabled="${isDisabled}">${date.getDate()}</button>`;
    }
    elements.calendarGrid.innerHTML = cellsHtml;
  }

  function renderTimeSlots() {
    if (!elements.timeSlotsContainer) return;
    const baseDate = state.selectedDate;
    if (!baseDate) { elements.timeSlotsContainer.innerHTML = ''; return; }

    const startOfDay = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), 8, 0, 0);
    const endOfDay   = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), 17, 0, 0);
    const interval = 30;
    const dateISO = `${baseDate.getFullYear()}-${pad2(baseDate.getMonth() + 1)}-${pad2(baseDate.getDate())}`;
    const pickedForDay = state.picks[dateISO] || [];

    let slotsHtml = '';
    for (let t = new Date(startOfDay); t < endOfDay; t = addMinutes(t, interval)) {
      if (addMinutes(t, state.duration) > endOfDay) break;

      const hhmm = `${pad2(t.getHours())}:${pad2(t.getMinutes())}`;
      const isPicked = pickedForDay.includes(hhmm);
      const label = formatInTZ(t, state.tz, { hour: 'numeric', minute: '2-digit' });
      const statusText = isPicked ? 'Selected' : 'Click to select';

      slotsHtml += `
        <button type="button"
          class="time-slot p-3 text-center rounded-lg border-2 transition-all ${isPicked ? 'slot-picked' : 'border-gray-300 bg-white text-gray-700 hover:border-blue-400 hover:bg-blue-50'}"
          data-date="${dateISO}" data-hhmm="${hhmm}" aria-pressed="${isPicked}">
          <span class="block font-medium">${label}</span>
          <span class="text-xs status">${statusText}</span>
        </button>
      `;
    }
    elements.timeSlotsContainer.innerHTML = slotsHtml;
    renderPickedPreview();
  }

  function renderPickedPreview() {
    if (!elements.pickedPreview) return;
    const sortedDates = Object.keys(state.picks).sort();
    const out = sortedDates
      .filter(d => state.picks[d].length > 0)
      .map(d => `<div class="mb-1"><span class="font-medium">${d}</span>: ${state.picks[d].join(', ')}</div>`);
    elements.pickedPreview.innerHTML = out.length ? out.join('') : '<em>No times selected yet.</em>';
  }

  function showSection(sectionElement) {
    [elements.dateSelection, elements.timeSelection, elements.confirmation, elements.successMessage]
      .filter(Boolean)
      .forEach(s => s.classList.add('hidden'));
    if (sectionElement) sectionElement.classList.remove('hidden');
    if (sectionElement && sectionElement.scrollIntoView) {
      sectionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ---------- Data Persistence & Logic ----------
  function persistAvailability() {
    const store = window.__demoStore;
    store[state.session] = store[state.session] || { candidate: null, client: null };
    store[state.session][state.role] = { tz: state.tz, duration: state.duration, picks: JSON.parse(JSON.stringify(state.picks)) };
    saveLocal();
    return store[state.session];
  }

  function intersectAndAutobook(sessionObj) {
    const { candidate, client } = sessionObj;
    if (!candidate || !client) return null;

    const allDates = [...new Set([...Object.keys(candidate.picks), ...Object.keys(client.picks)])].sort();
    for (const date of allDates) {
      const candTimes = new Set(candidate.picks[date] || []);
      const clientTimes = new Set(client.picks[date] || []);
      const overlap = [...candTimes].filter(time => clientTimes.has(time)).sort();
      if (overlap.length > 0) {
        return { date, time: overlap[0] };
      }
    }
    return { pending: true };
  }

  function displayAutoBookResult(result) {
    if (!elements.autobookResult) return;
    elements.autobookResult.classList.remove('hidden');
    let content = '';
    if (!state.session) {
      content = '<div>Enter or create a Session ID to share links.</div>';
    } else if (!result) {
      content = `<div>Waiting for the other party to submit… <span class="text-xs text-gray-500">(role: ${state.role})</span></div>`;
    } else if (result.pending) {
      content = '<div>Both submitted, but no overlapping times. Please select more slots or coordinate with the other party.</div>';
    } else {
      const [y, m, d] = result.date.split('-').map(Number);
      const [hh, mm] = result.time.split(':').map(Number);
      const start = new Date(y, m - 1, d, hh, mm);
      const end = addMinutes(start, state.duration);
      content = `
        <div class="text-sm">
          <div class="font-semibold text-green-700">✅ Auto-booked:</div>
          <div>${formatInTZ(start, state.tz, { weekday:'long', month:'long', day:'numeric', year:'numeric' })}</div>
          <div>${formatInTZ(start, state.tz, { hour:'numeric', minute:'2-digit' })} – ${formatInTZ(end, state.tz, { hour:'numeric', minute:'2-digit' })} (${state.tz})</div>
          <div class="mt-2 text-gray-600">(Demo: a real app would now create calendar invites.)</div>
        </div>`;
    }
    elements.autobookResult.innerHTML = content;
  }

  // ---------- EVENT HANDLERS ----------
  function handleDateSelect(e) {
    const target = e.target.closest('button.calendar-day');
    if (!target || target.disabled) return;

    const [y, m, d] = target.dataset.date.split('-').map(Number);
    state.selectedDate = new Date(y, m - 1, d);

    renderCalendar();
    updateStepIndicator(2);

    setTimeout(() => {
      if (elements.selectedDateSpan) {
        elements.selectedDateSpan.textContent = state.selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      }
      renderTimeSlots();
      if (elements.timeSelection) showSection(elements.timeSelection);
      saveLocal();
    }, 120);
  }

  function handleTimeSlotToggle(e) {
    const target = e.target.closest('button.time-slot');
    if (!target) return;

    const { date, hhmm } = target.dataset;
    state.picks[date] = state.picks[date] || [];
    const picksForDay = state.picks[date];
    const index = picksForDay.indexOf(hhmm);

    if (index === -1) picksForDay.push(hhmm);
    else picksForDay.splice(index, 1);

    state.picks[date].sort();

    target.classList.toggle('slot-picked');
    const isPicked = target.classList.contains('slot-picked');
    const statusEl = target.querySelector('.status');
    if (statusEl) statusEl.textContent = isPicked ? 'Selected' : 'Click to select';
    target.setAttribute('aria-pressed', isPicked);

    renderPickedPreview();
    updateStepIndicator(Object.values(state.picks).some(day => day.length > 0) ? 3 : 2);
    saveLocal();
  }

  function handleSaveDaySlots() {
    updateStepIndicator(3);
    if (elements.confirmation) showSection(elements.confirmation);
  }

  function handleSubmitAvailability() {
    if (!state.session) { alert('Please enter or create a Session ID first.'); return; }
    const sessionData = persistAvailability();
    const result = intersectAndAutobook(sessionData);
    displayAutoBookResult(result);
    if (elements.successMessage) showSection(elements.successMessage);
  }

  function handleScheduleAnother() {
    state.session = '';
    state.picks = {};
    state.selectedDate = null;
    if (elements.sessionIdInput) elements.sessionIdInput.value = '';
    window.history.pushState({}, '', window.location.pathname);
    updateStepIndicator(1);
    renderCalendar();
    if (elements.dateSelection) showSection(elements.dateSelection);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      alert('Links copied!');
    } catch (err) {
      console.warn('Clipboard API failed. Showing modal for manual copy.', err);
    }
  }

  function handleCopyLinks() {
    if (!state.session) { alert('Create or enter a Session ID first.'); return; }
    const links = buildShareLinks();
    if (elements.candLinkText) elements.candLinkText.value = links.cand;
    if (elements.cliLinkText) elements.cliLinkText.value = links.cli;
    if (elements.shareModal) elements.shareModal.classList.add('show');
    copyToClipboard(`Candidate Link: ${links.cand}\nClient Link: ${links.cli}`);
  }

  // ---------- INIT ----------
  function bindEventListeners() {
    const prev = $('#prev-month');
    prev && prev.addEventListener('click', () => { if (!state.viewMonth) state.viewMonth = new Date(); state.viewMonth.setDate(1); state.viewMonth.setMonth(state.viewMonth.getMonth() - 1); renderCalendar(); });

    const next = $('#next-month');
    next && next.addEventListener('click', () => { if (!state.viewMonth) state.viewMonth = new Date(); state.viewMonth.setDate(1); state.viewMonth.setMonth(state.viewMonth.getMonth() + 1); renderCalendar(); });

    const ns = $('#new-session');
    ns && ns.addEventListener('click', () => { state.session = newSessionId(); elements.sessionIdInput && (elements.sessionIdInput.value = state.session); saveLocal(); });

    elements.calendarGrid && elements.calendarGrid.addEventListener('click', handleDateSelect);
    elements.timeSlotsContainer && elements.timeSlotsContainer.addEventListener('click', handleTimeSlotToggle);

    const sds = $('#submit-day-slots');
    sds && sds.addEventListener('click', handleSaveDaySlots);
    const btt = $('#back-to-time');
    btt && btt.addEventListener('click', () => { elements.timeSelection && showSection(elements.timeSelection); updateStepIndicator(2); });
    const sa = $('#submit-availability');
    sa && sa.addEventListener('click', handleSubmitAvailability);
    const sna = $('#schedule-another');
    sna && sna.addEventListener('click', handleScheduleAnother);

    // --- State-updating controls ---
    elements.roleSelect && elements.roleSelect.addEventListener('change', (e) => { state.role = e.target.value; saveLocal(); });
    elements.sessionIdInput && elements.sessionIdInput.addEventListener('input', (e) => { state.session = e.target.value.trim(); });
    elements.tzSelect && elements.tzSelect.addEventListener('change', (e) => { state.tz = e.target.value; if(state.selectedDate) renderTimeSlots(); saveLocal(); });
    elements.durationSelect && elements.durationSelect.addEventListener('change', (e) => { state.duration = parseInt(e.target.value, 10); if(state.selectedDate) renderTimeSlots(); saveLocal(); });

    // --- Modal controls ---
    const cl = $('#copy-links');
    cl && cl.addEventListener('click', handleCopyLinks);
    const cs = $('#close-share');
    cs && cs.addEventListener('click', () => elements.shareModal && elements.shareModal.classList.remove('show'));
    const cc = $('#copy-cand');
    cc && cc.addEventListener('click', () => elements.candLinkText && copyToClipboard(elements.candLinkText.value));
    const ccl = $('#copy-cli');
    ccl && ccl.addEventListener('click', () => elements.cliLinkText && copyToClipboard(elements.cliLinkText.value));
    const dl = $('#download-share');
    dl && dl.addEventListener('click', () => {
      if (!elements.candLinkText || !elements.cliLinkText) return;
      const text = `Candidate: ${elements.candLinkText.value}\nClient: ${elements.cliLinkText.value}`;
      download(`motocruit-share-links-${state.session || 'links'}.txt`, text);
    });
  }

  function populateTZDropdown() {
    if (!elements.tzSelect) return;
    if (!US_TZS.includes(state.tz)) state.tz = 'America/New_York';
    elements.tzSelect.innerHTML = US_TZS
      .map(tz => `<option value="${tz}" ${tz === state.tz ? 'selected' : ''}>${tz}</option>`)
      .join('');
  }

  function initCore() {
    // Set logo
    if (elements.brandLogo) {
      elements.brandLogo.src = window.MOTOCRUIT_LOGO_URL || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    }

    // URL params
    const params = getParams();
    if (params.session) {
      state.session = params.session;
      elements.sessionIdInput && (elements.sessionIdInput.value = params.session);
    }
    if (params.role && ['candidate','client'].includes(params.role)) {
      state.role = params.role;
      elements.roleSelect && (elements.roleSelect.value = params.role);
    }

    // Try to load persisted local state if available
    const hadLocal = loadLocal();

    populateTZDropdown();

    // Calendar boot
    if (!state.viewMonth) {
      state.viewMonth = new Date();
      state.viewMonth.setDate(1);
    }
    renderCalendar();
    if (state.selectedDate) {
      if (elements.selectedDateSpan) {
        elements.selectedDateSpan.textContent = state.selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      }
      renderTimeSlots();
    }

    updateStepIndicator(1);
  }

  function safeInit() {
    try {
      bindElementsOrReport();
      initCore();
      bindEventListeners();
      console.log('%cInterview Scheduler V4.6 (Hardened) Initialized', 'color: green; font-weight: bold;');
    } catch (err) {
      const msg = document.createElement('div');
      msg.className = '_sched_error';
      msg.innerHTML = `<strong>Initialization error:</strong> ${String(err && err.message || err)}<br><small>Open the console for stack trace.</small>`;
      document.body.prepend(msg);
      console.error('Scheduler init error', err);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeInit, { once: true });
  } else {
    safeInit();
  }
})();
</script>
